# 隐私保护分析文档

## 1. 隐私保护机制概述

本系统采用多层次的隐私保护机制，确保知识库数据在存储、检索和生成全过程中的安全性。

## 2. 数据静态安全

### 2.1 加密存储

**机制**：
- 使用 AES-256-GCM 加密算法
- 每个文本块独立加密，使用随机 nonce
- 密文存储在向量数据库中

**验证方法**：
```python
# 查看向量数据库中的数据
from src.vector_db import QdrantDB
db = QdrantDB()
points = db.client.scroll(collection_name="encrypted_documents", limit=10)

# 所有 encrypted_text 字段均为密文（Base64编码）
for point in points[0]:
    print(point.payload['encrypted_text'][:50])  # 显示密文样例
```

**安全性证明**：
- ✅ 向量数据库不包含任何明文文本
- ✅ 即使数据库被窃取，攻击者无法获得原文
- ✅ 密钥单独存储，设置严格的文件权限（0o600）

### 2.2 向量与密文分离

**设计原理**：
- 向量表示语义信息，但不包含具体内容
- 密文包含具体内容，但无法直接读取
- 两者关联存储，查询时配合使用

**隐私优势**：
- 向量检索不会泄露查询意图
- 攻击者即使获得向量，也无法还原原文
- 向量空间搜索不涉及明文

## 3. 数据动态安全

### 3.1 临时解密机制

**工作流程**：
1. 检索返回加密文本
2. 在内存中解密
3. 构建上下文
4. 发送给 LLM
5. 解密内容不写入磁盘
6. 处理完成后内存释放

**安全特性**：
- ✅ 解密仅在查询时发生
- ✅ 解密数据存在于内存，不持久化
- ✅ 查询结束后，解密内容被丢弃
- ✅ 不生成临时明文文件

### 3.2 本地处理

**架构优势**：
```
传统云端 RAG:
用户 → 网络 → 云服务器 → 第三方存储
      ↑ 风险点      ↑ 风险点    ↑ 风险点

本系统:
用户 → 本地系统 (无网络传输)
      ✓ 安全
```

**隐私保证**：
- ✅ 所有处理在本地完成
- ✅ 无数据上传到云端
- ✅ 离线可用
- ✅ 数据完全自主控制

## 4. 操作可审计

### 4.1 审计日志设计

**日志内容**：
```json
{
    "timestamp": "2024-01-01T00:00:00",
    "category": "query",
    "event_type": "search_executed",
    "metadata": {
        "query_hash": "abc123...",
        "num_results": 5,
        "response_time_seconds": 1.23
    },
    "integrity_hash": "def456..."
}
```

**隐私保护措施**：
- ✅ 不记录原始查询文本
- ✅ 使用 SHA-256 哈希代替敏感信息
- ✅ 过滤所有敏感字段
- ✅ 日志可审计，但不泄露隐私

### 4.2 完整性验证

**机制**：
- 每条日志包含完整性哈希
- 哈希基于日志内容计算
- 可验证日志未被篡改

**验证方法**：
```python
from src.audit import AuditLogger

logger = AuditLogger()
with open("logs/audit.log", 'r') as f:
    for line in f:
        is_valid = logger.verify_log_integrity(line)
        print(f"Log integrity: {'✓' if is_valid else '✗'}")
```

## 5. 威胁模型与防护

### 5.1 威胁分析

| 威胁 | 风险等级 | 防护措施 | 效果 |
|-----|---------|---------|-----|
| 数据库泄露 | 高 | 加密存储 | ✓ 有效 |
| 内存转储 | 中 | 临时解密 | ✓ 降低风险 |
| 网络窃听 | 无 | 本地处理 | ✓ 完全避免 |
| 日志泄露 | 低 | 敏感数据过滤 | ✓ 有效 |
| 密钥泄露 | 高 | 权限控制 | ⚠ 需人工管理 |
| 侧信道攻击 | 低 | 常数时间操作 | △ 部分防护 |

### 5.2 攻击场景分析

#### 场景1：数据库被盗
**攻击路径**：攻击者获得向量数据库文件

**防护**：
- 所有文本均为 AES-256 密文
- 无密钥无法解密
- 向量不包含语义信息

**结论**：✓ 数据安全

#### 场景2：内存分析
**攻击路径**：攻击者对运行中的系统进行内存转储

**防护**：
- 解密数据仅短暂存在
- 查询结束后立即释放
- 不使用持久化缓存

**结论**：⚠ 有风险，但攻击窗口极小

#### 场景3：日志分析
**攻击路径**：攻击者获得审计日志

**防护**：
- 日志不包含查询原文
- 所有敏感信息经过哈希
- 无法从日志还原用户行为

**结论**：✓ 隐私保护良好

## 6. 与云端 RAG 对比

### 6.1 架构对比

| 维度 | 本系统（本地） | 云端 RAG |
|-----|--------------|---------|
| **数据位置** | 本地磁盘 | 云端服务器 |
| **数据传输** | 无 | 需要（HTTPS） |
| **处理位置** | 本地 CPU/GPU | 云端计算 |
| **数据控制** | 完全自主 | 依赖服务商 |
| **隐私风险** | 极低 | 中-高 |
| **合规性** | 易满足 | 需评估 |
| **离线能力** | ✓ 支持 | ✗ 不支持 |
| **成本** | 一次性硬件 | 持续订阅 |

### 6.2 隐私优势

1. **数据主权**
   - 本系统：数据完全本地，用户完全控制
   - 云端：数据存储在第三方，存在风险

2. **网络安全**
   - 本系统：无网络传输，杜绝中间人攻击
   - 云端：依赖 HTTPS，仍有风险

3. **服务商风险**
   - 本系统：无第三方，无信任问题
   - 云端：依赖服务商诚信和安全能力

4. **法律合规**
   - 本系统：满足 GDPR、数据本地化等要求
   - 云端：需评估服务商合规性

## 7. 隐私保护最佳实践

### 7.1 部署建议

1. **密钥管理**
   ```bash
   # 生成密钥后立即设置权限
   chmod 600 config/encryption.key
   
   # 定期轮换密钥（重要！）
   ```

2. **网络隔离**
   ```bash
   # 使用防火墙限制访问
   # 仅允许本地访问
   ```

3. **日志管理**
   ```bash
   # 定期清理旧日志
   find logs/ -name "*.log" -mtime +30 -delete
   ```

### 7.2 使用建议

1. **敏感文档处理**
   - 定期备份加密密钥（安全存储）
   - 重要文档额外加密一层
   - 定期审计访问日志

2. **系统维护**
   - 及时更新依赖库
   - 监控系统异常
   - 定期安全审计

## 8. 安全认证建议

### 8.1 可进行的安全测试

1. **渗透测试**
   - 数据库访问测试
   - 内存分析测试
   - 日志泄露测试

2. **合规认证**
   - GDPR 合规性评估
   - 数据本地化认证
   - 隐私影响评估（PIA）

### 8.2 第三方审计

建议进行以下审计：
- 代码安全审计
- 加密实现审计
- 隐私保护评估

## 9. 已知限制

### 9.1 当前限制

1. **密钥管理**
   - 需要用户自行保管密钥
   - 密钥丢失则数据无法恢复

2. **内存安全**
   - 解密后数据在内存中可能被转储
   - 建议在安全环境中运行

3. **系统访问控制**
   - 当前无用户认证机制
   - 需要配合操作系统访问控制

### 9.2 未来改进方向

1. **更强的加密**
   - 同态加密
   - 安全多方计算
   - 零知识证明

2. **更完善的密钥管理**
   - 密钥派生函数（KDF）
   - 密钥轮换机制
   - 硬件安全模块（HSM）

3. **用户认证**
   - 多因素认证
   - 基于角色的访问控制（RBAC）
   - 审计追踪

## 10. 结论

本系统通过以下机制实现了全面的隐私保护：

✅ **数据静态安全**：AES-256-GCM 加密，密文存储

✅ **数据动态安全**：临时解密，内存处理，无持久化

✅ **操作可审计**：完整日志，无敏感数据，完整性验证

✅ **架构安全**：本地处理，无网络传输，数据自主

与云端 RAG 相比，本系统在隐私保护方面具有显著优势，适用于对数据隐私有严格要求的场景。
